name: Deploy API to AWS ECS (Production)

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md" # Ignora arquivos de documenta√ß√£o para n√£o rodar desnecessariamente
  pull_request:
    branches: ["main"]

env:
  # Vari√°veis de Ambiente Globais para o Projeto
  AWS_REGION: "us-east-1" # Substitua pela sua regi√£o AWS
  ECS_CLUSTER_NAME: "autolog-prod-cluster"
  ECS_SERVICE_NAME: "autolog-api-service"
  ECR_REPOSITORY: "autolog-api-repo"
  TASK_DEFINITION_PATH: "task-definition.json" # Arquivo na raiz do projeto
  MIGRATION_SECRET_NAME: "autolog-prod-db-connection"

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # --- Configura√ß√£o de Credenciais AWS via OIDC ---
      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }} # Seu ARN do IAM Role
          role-session-name: "github-deployment-session"

      # --- Etapa 1: Build, Bundle e Push para ECR ---

      - name: üèóÔ∏è Build, Publish, and Generate EF Migration Bundle
        run: |
          # CAMINHOS CORRIGIDOS para o arquivo na raiz
          PROJECT_FILE="autolog-dotnet-api.csproj"

          # 1. Publica a aplica√ß√£o
          dotnet publish $PROJECT_FILE -c Release -o ./publish-output /p:UseAppHost=false

          # 2. Gera o execut√°vel do EF Core Migration Bundle
          dotnet ef migrations bundle --project $PROJECT_FILE --startup-project $PROJECT_FILE --self-contained -r linux-x64 -o ./publish-output/efbundle

      - name: üê≥ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üì¶ Build and Tag Docker Image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # O Dockerfile deve estar na raiz
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f Dockerfile .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: ‚¨ÜÔ∏è Push Docker Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # --- Etapa 2: Executar a Migra√ß√£o Dedicada (ECS Run Task) ---

      - name: üöÄ Run DB Migrations Task
        id: run-migrations
        uses: aws-actions/amazon-ecs-run-task@v1
        with:
          task-definition: ${{ env.TASK_DEFINITION_PATH }}
          cluster: ${{ env.ECS_CLUSTER_NAME }}
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          # Comando para rodar o Bundle (Verifique seu Dockerfile para o caminho exato)
          # Assumindo que o bundle foi copiado para o diret√≥rio de trabalho do cont√™iner (/app/)
          cmd: ./efbundle
          # Inje√ß√£o da String de Conex√£o via Secrets Manager
          container-environment-secrets: |
            ConnectionStrings:DefaultConnection=${{ env.MIGRATION_SECRET_NAME }}
          # Configura√ß√µes de Rede (Subnets e Security Groups)
          subnets: ${{ secrets.RDS_SUBNETS }}
          security-groups: ${{ secrets.RDS_SECURITY_GROUPS }}

      # --- Etapa 3: Deployment do Servi√ßo ECS ---

      - name: üîÑ Deploy New Task Definition to ECS Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ env.TASK_DEFINITION_PATH }}
          service: ${{ env.ECS_SERVICE_NAME }}
          cluster: ${{ env.ECS_CLUSTER_NAME }}
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}

      - name: ‚úÖ Migration and Deployment Successful
        run: echo "API Deployed e Migra√ß√£o Aplicada com Sucesso!"
